name: Codex Code Review

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
    types: [opened, synchronize, reopened]

jobs:
  codex-review:
    name: Run Codex Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          # Get files changed in PR
          git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} > changed_files.txt
          
          # Filter for code files only
          cat changed_files.txt | grep -E '\.(rs|go|js|ts|py|java|cpp|h|c|cs|rb|php)$' | tr '\n' ',' > code_files.txt
          
          echo "count=$(wc -l < code_files.txt)" >> $GITHUB_OUTPUT
          echo "files=$(cat code_files.txt)" >> $GITHUB_OUTPUT

      - name: Run Codex Review
        id: codex
        run: |
          # Get diff for review
          git diff origin/${{ github.base_ref }}...${{ github.sha }} > pr_diff.txt

          # Run Codex review script
          python3 .github/scripts/codex-review.py \
            --diff pr_diff.txt \
            --format json \
            --output codex-review.json

          # Check if review has issues
          ISSUE_COUNT=$(jq -r '.issues | length' codex-review.json 2>/dev/null || echo "0")
          echo "issue_count=${ISSUE_COUNT}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format review comment
        id: format
        run: |
          # Create markdown comment
          cat > review-comment.md << 'EOF'
          ## ðŸ” Codex Code Review

          **Repository:** ${{ github.repository }}
          **PR:** #${{ github.event.pull_request.number }}
          **Commit:** `${{ github.sha }}`

          EOF

          # Format issues by severity
          echo "" >> review-comment.md
          echo "### ðŸ“‹ Review Summary" >> review-comment.md
          echo "" >> review-comment.md
          echo "| Severity | Category | File | Line | Issue |" >> review-comment.md
          echo "|----------|----------|------|------|--------|" >> review-comment.md

          # Parse and format issues from JSON file
          if [ -f "codex-review.json" ] && command -v jq &> /dev/null; then
            jq -r '.issues[]? | "| " + .severity + " | " + .category + " | " + .file + " | " + (.line|tostring) + " | " + .message + " |"' codex-review.json >> review-comment.md 2>/dev/null || echo "| â„¹ï¸ | info | - | - | No code issues found |" >> review-comment.md
          else
            echo "| â„¹ï¸ | info | - | - | No code files to review or jq not available |" >> review-comment.md
          fi

          echo "" >> review-comment.md
          echo "---" >> review-comment.md
          echo "" >> review-comment.md
          echo "**Categories checked:**" >> review-comment.md
          echo "âœ… **Best Practices** - Code style, naming conventions, SOLID principles" >> review-comment.md
          echo "âœ… **Bugs** - Logic errors, null checks, off-by-one, race conditions" >> review-comment.md
          echo "âœ… **Security** - SQL injection, XSS, auth issues, secrets in code" >> review-comment.md
          echo "" >> review-comment.md
          echo "*Generated by Codex Agent* ðŸ¤–"

          echo "comment=$(cat review-comment.md)" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('review-comment.md', 'utf8');
            
            // Find existing review comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ðŸ” Codex Code Review')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new review comment');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set review status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let issues = [];

            try {
              const reviewData = fs.readFileSync('codex-review.json', 'utf8');
              const parsed = JSON.parse(reviewData);
              issues = parsed.issues || [];
            } catch (error) {
              console.log('No review data or invalid JSON:', error.message);
            }

            // Determine status based on issues found
            let status = 'success';
            let description = 'No issues found';

            if (issues.some(i => i.severity === 'error')) {
              status = 'failure';
              description = 'Critical issues found';
            } else if (issues.some(i => i.severity === 'warning')) {
              status = 'warning';  // Note: 'warning' is not a valid GitHub status, use 'success' with description
              description = 'Warnings found';
            }

            // Use PR head SHA instead of context.sha for PR workflows
            const sha = context.event.pull_request
              ? context.payload.pull_request.head.sha
              : context.sha;

            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha,
                state: status === 'warning' ? 'success' : status,
                context: 'codex-review',
                description: description
              });
            } catch (error) {
              // Log error but don't fail the step
              console.log('Could not set commit status:', error.message);
              console.log('This may happen due to permission restrictions on PRs from forks');
            }
            
            // Determine status based on issues found
            let status = 'success';
            let description = 'No issues found';
            
            if (issues.some(i => i.severity === 'error')) {
              status = 'failure';
              description = 'Critical issues found';
            } else if (issues.some(i => i.severity === 'warning')) {
              status = 'warning';
              description = 'Warnings found';
            }
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              context: 'codex-review',
              description: description
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
